<script>
const obj = {
    a: {b: 3},
    b: 2,
}

const cbs = new Map();
let reactivities = new Map();

let usedReactivities = [];

const po = reactive(obj);

effect(() => {
    console.log(po.a.b)
})

function effect(cb) {
    usedReactivities = [];
    cb();
    console.log(usedReactivities);

    for (let reactivity of usedReactivities) {
        if (!cbs.has(reactivity[0])) {
            cbs.set(reactivity[0], new Map())
        }
        if (!cbs.get(reactivity[0]).has(reactivity[1])) {
            cbs.get(reactivity[0]).set(reactivity[1], []);
        }
        cbs.get(reactivity[0]).get(reactivity[1]).push(cb);
    }
}

function reactive(obj) {
    if (reactivities.has(obj)) {
        return reactivities.get(obj);
    }

    let proxy = new Proxy(obj, {
        set(obj, prop, val) {
            obj[prop] = val;
            if (cbs.has(obj) && cbs.get(obj).has(prop)) {
                for (let cb of cbs.get(obj).get(prop)) {
                    cb();
                }
            }
            return obj;
        },

        get(obj, prop) {
            usedReactivities.push([obj, prop])
            if( typeof obj[prop] === 'object') {
                return reactive(obj[prop]);
            }
            return obj[prop];
        }
    })

    reactivities.set(obj, proxy);
    return proxy;
}



</script>
